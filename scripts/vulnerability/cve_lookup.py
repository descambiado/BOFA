#!/usr/bin/env python3
"""
CVE Lookup - Inteligencia de vulnerabilidades
=============================================

Consulta la base de datos local de vulnerabilidades (formato BOFA).
Filtros por id, product, limit. Salida JSON.

Uso:
    python3 cve_lookup.py
    python3 cve_lookup.py --product web_framework
    python3 cve_lookup.py --id CVE-2024-0001
    python3 cve_lookup.py --limit 3
"""

import argparse
import json
import sys
from pathlib import Path

# Directorio del script para cargar cve_data.yaml
_SCRIPT_DIR = Path(__file__).resolve().parent
_DATA_FILE = _SCRIPT_DIR / "cve_data.yaml"


def load_data():
    """Carga los datos de vulnerabilidades desde YAML."""
    try:
        import yaml
    except ImportError:
        print(json.dumps({"error": "PyYAML no instalado"}), file=sys.stderr)
        return []
    if not _DATA_FILE.exists():
        return []
    with open(_DATA_FILE, "r", encoding="utf-8") as f:
        data = yaml.safe_load(f) or {}
    return data.get("entries", [])


def main():
    parser = argparse.ArgumentParser(description="Consulta de vulnerabilidades (base local BOFA)")
    parser.add_argument("--id", type=str, default=None, help="Filtrar por ID de vulnerabilidad")
    parser.add_argument("--product", type=str, default=None, help="Filtrar por producto")
    parser.add_argument("--limit", type=int, default=20, help="MÃ¡ximo de resultados (default 20)")
    args = parser.parse_args()

    entries = load_data()
    if not entries:
        print(json.dumps({"count": 0, "entries": []}, indent=2))
        return 0

    if args.id:
        entries = [e for e in entries if e.get("id") == args.id]
    if args.product:
        entries = [e for e in entries if (e.get("product") or "").lower() == args.product.lower()]
    entries = entries[: args.limit]

    print(json.dumps({"count": len(entries), "entries": entries}, indent=2))
    return 0


if __name__ == "__main__":
    sys.exit(main())
